<% isChild = (typeof isChild === 'undefined') ? false : isChild; %>

<% _.each(data, function(d) { %>
    <% var subscribedAll = false; %>
    <% var subscribedSome = false; %>
    <% if (!isChild && d.Series) { %>
        <% var numSubscribed = _.size(_.filter(d.Series, {'subscribed': true})); %>
        <% subscribedAll = (numSubscribed === d.Series.length) %>
        <% subscribedSome = (numSubscribed && numSubscribed < d.Series.length) %>
    <% } %>
    <li class="list-group-item <% if (d.expanded) { %>gh-list-group-item-open<% } %> <% if (d.subscribed || (!isChild && subscribedAll)) { %> gh-list-group-item-added <% } %>" data-id="<%- d.id %>">
        <div class="gh-list-group-item-container">
            <% if (!isChild) { %>
                <button class="btn btn-link gh-toggle-list">
                    <div class="gh-list-icon">
                        <i class="fa <% if (d.expanded) { %>fa-caret-down<% } else { %>fa-caret-right<% } %>"></i>
                    </div>
            <% } %>
                    <% if (isChild) { %>
                        <!-- Additional series info popover trigger -->
                        <div class="gh-list-info">
                            <i class="fa fa-info-circle" data-id="<%- d.id %>"></i>
                        </div>
                    <% } %>
                    <div class="gh-list-description">
                        <p class="gh-list-description-text"><%- d.displayName %></p>
                        <% if (isChild) { %>
                            <% if (d.metadata) { %>
                                <% if (d.metadata.locations) { %>
                                    <% if (d.metadata.locations.length > 1) { %>
                                        <p class="gh-list-metadata">Multiple locations</p>
                                    <% } else if (d.metadata.locations.length === 1) { %>
                                        <p class="gh-list-metadata"><%- d.metadata.locations[0] %></p>
                                    <% } else { %>
                                        <p class="gh-list-metadata no-information">Location not known</p>
                                    <% } %>
                                <% } %>
                                <% if (d.metadata.organisers) { %>
                                    <% if (d.metadata.organisers.length > 1) { %>
                                        <p class="gh-list-metadata">Multiple organisers</p>
                                    <% } else if (d.metadata.organisers.length === 1) { %>
                                        <p class="gh-list-metadata"><%- d.metadata.organisers[0] %></p>
                                    <% } else { %>
                                        <p class="gh-list-metadata no-information">Lecturer not known</p>
                                    <% } %>
                                <% } %>
                            <% } %>
                        <% } %>
                    </div>
            <% if (!isChild) { %>
                </button>
            <% } %>

            <!-- Borrowed status -->
            <% if (isChild && d.borrowedFrom) { %>

                <!-- Borrowed popover-->
                <% var _templateId = 'gh-template-' + Math.ceil(Math.random() * 1000) %>
                <div id="<%- _templateId %>">
                    <% _.renderPartial('series-borrowed-popover', {'data': d}, '#' + _templateId) %>
                </div>

                <!-- Borrowed popover-->
                <% _templateId = 'gh-template-' + Math.ceil(Math.random() * 1000) %>
                <div id="<%- _templateId %>">
                    <% _.renderPartial('series-borrowed-published-popover', {'data': d}, '#' + _templateId) %>
                </div>

                <!-- Borrowed icon -->
                <div class="gh-series-borrowed">
                    <% if (d.borrowedFrom) { %>
                        <span class="gh-borrowed-icon-container">
                            <i class="fa fa-link" data-id="<%- d.id %>"></i>
                        </span>
                    <% } %>
                </div>
            <% } %>

            <!-- Series actions -->
            <div class="gh-list-action">

                <!-- Disabled button overlay -->
                <% if (d.borrowedFrom && d.borrowedFrom.Parent && !d.borrowedFrom.Parent.published) { %>
                    <div class="gh-disabled-overlay" data-id="<%- d.id %>"></div>
                <% } %>

                <% if (d.subscribed || (!isChild && subscribedAll)) { %>
                    <button class="btn btn-link <% if (isChild) { %>gh-remove-from-calendar<% } else { %>gh-remove-all-from-calendar<% } %>" <% if (d.borrowedFrom && d.borrowedFrom.Parent && !d.borrowedFrom.Parent.published) { %>disabled<% } %>>
                        <i class="fa fa-remove"></i>
                    </button>
                <% } else { %>
                    <button class="btn btn-link <% if (isChild) { %>gh-add-to-calendar<% } else { %>gh-add-all-to-calendar<% } %>" <% if (d.borrowedFrom && d.borrowedFrom.Parent && !d.borrowedFrom.Parent.published) { %>disabled<% } %>>
                        <% if (!isChild && subscribedSome) { %>
                            <i class="fa fa-minus"></i>
                        <% } else { %>
                            <i class="fa fa-plus"></i>
                        <% } %>
                    </button>
                <% } %>
            </div>
        </div>
        <% if (d.Series) { %>
            <% var _templateId = 'gh-template-' + Math.ceil(Math.random() * 1000) %>
            <ul class="list-group" id="<%- _templateId %>">
                <li>test</li>
                <%
                    /*
                     It only works because of the timeout...

                    setTimeout(function(){_.renderPartial('student-module-item', {
                        'data': d.Series,
                        'isChild': true
                    }, '#' + _templateId)}, 250);
                    */
                %>
            </ul>
        <% } %>
    </li>
<% }); %>
